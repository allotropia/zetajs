<!DOCTYPE html>
<html>
  <meta charset="utf-8">
  <style>
    iframe {height: 90vh; width: 100vw;}
  </style>
  <body>
    <input type="file" id="input" disabled/>
    <label><input type=checkbox id="download"/> Download</label>
    <iframe id="frame"></iframe>
    <canvas id="qtcanvas" style="display: none"/>
    <script type="text/javascript">
      // Enable usage of LOWA builds with UI.
      const canvas = document.getElementById('qtcanvas');
      var Module = {canvas, uno_scripts: ['./zeta.js', './convertpdf.js']};
    </script>
    <script src="soffice.js" type="text/javascript"></script>
    <script type="text/javascript">
      Module.uno_main.then(function(port) {
          const input = document.getElementById('input');
          input.onchange = function() {
              input.disabled = true;
              const file = input.files[0];
              let name = file.name;
              // Use a canonical /tmp/input pathname so that it cannot clash with whatever relevant
              // files might already be present there (which should not be named "input"), but
              // append the original file name extension so that LO's type detection can use it to
              // determine the input file type:
              let from = '/tmp/input';
              const n = name.lastIndexOf('.');
              if (n > 0) {
                  from += name.substring(n);
                  name = name.substring(0, n);
              }
              file.arrayBuffer().then(data => {
                  FS.writeFile(from, new Uint8Array(data));
                  port.postMessage({cmd: 'convert', name, from, to: '/tmp/output'});
              });
          };
          port.onmessage = function(e) {
              switch (e.data.cmd) {
              case 'converted':
                  try { FS.unlink(e.data.from); } catch {}  // for easier debugging
                  const data = FS.readFile(e.data.to);
                  const blob = new Blob([data], {type: 'application/pdf'});
                  const url = URL.createObjectURL(blob);
                  document.getElementById('frame').contentWindow.open(url, '_self');
                  if (document.getElementById("download").checked) {
                      const link = document.createElement('a');
                      link.href = url;
                      link.download = e.data.name + '.pdf';
                      link.style = 'display:none';
                      document.body.appendChild(link);
                      link.click();
                      document.body.removeChild(link);
                  }
                  try { FS.unlink(e.data.to); } catch {}  // for easier debugging
                  URL.revokeObjectURL(url);
                  // fallthrough
              case 'start':
                  input.disabled = false;
                  break;
              default:
                  throw Error('Unknonwn message command ' + e.data.cmd);
              }
          };
      });
    </script>
  </body>
</html>
