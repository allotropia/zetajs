<!DOCTYPE html>
<!-- SPDX-License-Identifier: MIT -->
<html>
  <meta charset="utf-8">
  <head>
    <style>
        .disable-mouse-input {
            cursor: not-allowed;
            pointer-events: none;
        }
    </style>
  </head>
  <body>
    <div><h1>ZetaJS Ping Monitor Demo</h1></div><br>
    <div>
      <button onclick="btnPing()">Ping</button>&nbsp; 
        <input type="text" id="ping_target" name="ping_target" value="https://zetaoffice.org/">
    </div><br>
    <div>
      <canvas id="qtcanvas" width="1150px" height="500px" class="disable-mouse-input"/>
      <!--
        In this demo the canvas content isn't editable.
        To make it editable, add:
          contenteditable="true" oncontextmenu="event.preventDefault()" onkeydown="event.preventDefault()"
      -->
    </div>
    <script src="ping.js" type="text/javascript"></script>
    <script type="text/javascript">
        'use strict';

        // IMPORTANT:
        // Set base URL to the soffice.* files.
        // Use an empty string if those files are in the same directory.
        const soffice_base_url = '';


        var Module = {
            canvas: document.getElementById('qtcanvas'),
            uno_scripts: ['./zeta.js', './office_thread.js'],
            locateFile: function(path, prefix) { return (prefix || soffice_base_url) + path; },
        };
        if (soffice_base_url !== '') {
            // Must not be set when soffice.js is in the same directory.
            Module.mainScriptUrlOrBlob = new Blob(
                ["importScripts('"+soffice_base_url+"soffice.js');"], {type: 'text/javascript'});
        }

        let thrPort;     // zetajs thread communication
        const pingTarget = document.getElementById("ping_target");
        const pingInst = new Ping();
        let url = pingTarget.value;


        function btnPing() {
            url = pingTarget.value;
        }
        pingTarget.addEventListener ("keyup", (evt) => {
            if(evt.key === 'Enter') btnPing();
        });

        async function load_ping_monitor_ods() {
            const response = await fetch("./ping_monitor.ods");
            return response.arrayBuffer();
        }
        let ping_monitor_ods;

        async function doPing() {
            if (url != '') {
                pingInst.ping(url, function(err, ping_value) {
                    // err: In /favicon.ico can't be loaded the result still represents the response time.
                    console.log({url, ping_value});
                    thrPort.postMessage({cmd: 'ping_result', url, ping_value});
                });
            }
        }


        const soffice_js = document.createElement("script");
        soffice_js.src = soffice_base_url + "soffice.js";
        // "onload" runs after the loaded script has run.
        soffice_js.onload = function() {
            console.log('PLUS: Configuring Module');
            Module.uno_main.then(function(pThrPort) {
                thrPort = pThrPort;
            
                load_ping_monitor_ods().then(function(aryBuf) {
                    ping_monitor_ods = aryBuf;
                    FS.writeFile('/tmp/ping_monitor.ods', new Uint8Array(ping_monitor_ods));
                });
            
                // Trigger resize of the embedded window to match the canvas size.
                //window.dispatchEvent(new Event('resize'));  // TODO: see topwin.setPosSize workaround
                // May somewhen be obsoleted by:
                //   https://gerrit.libreoffice.org/c/core/+/174040
            
                setTimeout(function() {
                    //window.dispatchEvent(new Event('resize'));  // TODO: see topwin.setPosSize workaround
                    // Using Ping callback interface.
                    // 'Cross-Origin-Embedder-Policy': Does NOT work with 'require-corp'.
                    //   But you may use 'credentialless'
                    pingInst.ping(pingTarget, function() {
                        // Continue after first ping, which is often exceptionally slow.
                        setInterval(function() {
                            doPing();
                        }, 1000);  // milliseconds
                    });
                }, 10000);  // milliseconds
            });
        };
        // Hint: The global objects "canvas" and "Module" must exist before the next line.
        document.body.appendChild(soffice_js);
    </script>
  </body>
</html>
